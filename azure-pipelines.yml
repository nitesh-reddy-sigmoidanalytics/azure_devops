# -----------------------------------------------------
# Build & Push Docker Image to ACR
# Publish Kubernetes Manifests for Release Pipeline
# -----------------------------------------------------

trigger:
- main

variables:
  # Service connection to ACR (GUID or name)
  dockerRegistryServiceConnection: '8e0dfcb1-850f-470c-be8a-90a37322cd1d'

  # Image repo name inside ACR
  imageRepository: 'niteshreddysigmoidanalyticsazuredevops'

  # The ACR login server
  containerRegistry: 'mydevops.azurecr.io'

  # Dockerfile path (relative)
  dockerfilePath: 'Dockerfile'

  # Image tag = Build ID
  tag: '$(Build.BuildId)'

  # Kubernetes pull secret name
  imagePullSecret: 'mydevops7599-auth'

  # Self-hosted agent pool
  agentPoolName: 'self hosted pool'


stages:

# -----------------------------------------------------
# BUILD STAGE
# -----------------------------------------------------
- stage: Build
  displayName: Build & Push Stage

  jobs:
  - job: Build
    displayName: Build Docker Image
    pool:
      name: $(agentPoolName)

    steps:

    # Login to ACR (required for self-hosted agents)
    - task: AzureCLI@2
      displayName: Login to Azure Container Registry
      inputs:
        azureSubscription: $(dockerRegistryServiceConnection)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "Logging into ACR..."
          az acr login --name $(containerRegistry)

    # Build & Push Docker Image
    - task: Docker@2
      displayName: Build & Push Docker Image
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)

    # Publish Kubernetes manifests to Release Pipeline
    - task: PublishPipelineArtifact@1
      displayName: Publish Manifests
      inputs:
        targetPath: 'manifests'
        artifact: 'manifests'
        publishLocation: 'pipeline'
